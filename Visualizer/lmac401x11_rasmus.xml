<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE nta PUBLIC '-//Uppaal Team//DTD Flat System 1.1//EN' 'http://www.it.uu.se/research/group/darts/uppaal/flat-1_2.dtd'>
<nta>
	<declaration>
//Insert declarations of global clocks, variables, constants and channels.
broadcast chan  sendWM; // send msg
broadcast chan  tick;

clock t;

const int CONFIG_NR_NODES = 4;// number of nodes in the network
const int CONFIG_frame = 5;          // number of slots in a frame
const int frame = CONFIG_frame;
const int max_vec = (1&lt;&lt;(frame))-1; // maximal value of bit vector (if all entries are 1)

typedef int [0,CONFIG_NR_NODES-1] id_t;

// the following are variable that contains data send from one node to another;
//int[0,max_vec] aux_vec;
//int[0,frame] aux_slot;
int[0,CONFIG_NR_NODES] aux_id;
int[-1,frame-1] aux_col;

// Derived from 503x1. Omitted all additional collision patches, but kept all bug fixes.
bool CONFIG_connected[4] [4]={{ 0, 1, 1,1},{ 1, 0, 1,1},{ 1, 1, 0,1},{ 1, 1, 1,0}};
// collision patches are
// don't sent, when in listening no info received (got_info)
// don't sent when your alone (alone)
// when a node selected but did not send, and slot gets occupied, select new (sent_info)

// the topology of the network
//bool can_hear[5] [5] :={{ 0, 1, 0, 0, 0},{ 1, 0, 1, 0, 0},{ 0, 1, 0, 1, 0},{ 0, 0, 1, 0, 1},{ 0, 0, 0, 1, 0}};
//bool can_hear[5] [5] :={{ 0, 1, 1, 0, 0},{ 1, 0, 0, 1, 0},{ 1, 0, 0, 0, 0},{ 0, 1, 0, 0, 1},{ 0, 0, 0, 1, 0}};// top 12
//bool can_hear[number_of_nodes] [number_of_nodes] ={{0,1,1,0},{1,0,1,1}, {1,1,0,1},{0,1,1,0}};
//bool can_hear[4] [4] ={{ 0, 1, 0,0},{ 1, 0, 1,0},{ 0, 1, 0,1},{ 0, 0, 1,0}};// topology 1
//bool can_hear[4] [4] ={{ 0, 1, 1,0},{ 1, 0, 0,1},{ 1, 0, 0,0},{ 0, 1, 0,0}}; // topology 4
//bool can_hear[4] [4] ={{ 0, 1, 1,0},{ 1, 0, 0,1},{ 1, 0, 0,1},{ 0, 1, 1,0}};//topology 5
//bool can_hear[4] [4] ={{ 0, 1, 0,0},{ 1, 0, 1,0},{ 0, 1, 0,1},{ 0, 0, 1,0}};

// (not so) local data
//int[-1,frame-1] current[number_of_nodes]={0,-1,-1,-1};
int[0,max_vec] first[CONFIG_NR_NODES];
int[0,max_vec] second[CONFIG_NR_NODES]; 
int[-1,frame] OUTPUT_slot_no[CONFIG_NR_NODES]={0,-1,-1,-1};
				</declaration>
	<template>
		<name x="5" y="5">node</name>
		<parameter>const id_t id</parameter>
		<declaration>//Insert local declarations of clocks, variables and constants.

//int next;	   // wait 0..3 frames before choosing a slot, counts the number of slots without receiving a message
//int[0,number_of_nodes] rec_id;		// received id
int[0,max_vec] aux_vec, rec_vec;
	
int[-1,frame] OUTPUT_current=-1;	// some counters, current is the current slot no.
int[-1,3*frame] counter=-1; 
int[-1,frame-1] col=-1, collision=-1;
	// vector to keep track of when a collision did occur.

int[0,4] mode=0;// just for book keeping.
//clock t;

void setgatewayVars() {
    OUTPUT_current = 0;
    counter = 4;
    mode = 3;
}</declaration>
		<location id="id0" x="-153" y="365">
			<name x="-163" y="331">TIMELOCKED</name>
		</location>
		<location id="id1" x="289" y="561">
			<committed/>
		</location>
		<location id="id2" x="289" y="501">
			<name x="229" y="459">waiting</name>
			<label kind="invariant" x="229" y="476">t &lt;= 2</label>
		</location>
		<location id="id3" x="-272" y="229">
			<name x="-331" y="195">select_node_or_gateway</name>
			<urgent/>
		</location>
		<location id="id4" x="288" y="232">
			<name x="312" y="224">initial</name>
		</location>
		<location id="id5" x="288" y="1088">
			<committed/>
		</location>
		<location id="id6" x="288" y="896">
			<committed/>
		</location>
		<location id="id7" x="288" y="760">
			<label kind="invariant" x="304" y="768">t&lt;=2</label>
			<committed/>
		</location>
		<location id="id8" x="-96" y="1360">
			<name x="-104" y="1376">sending</name>
			<committed/>
		</location>
		<location id="id9" x="224" y="1360">
			<name x="216" y="1392">sent</name>
			<label kind="invariant" x="214" y="1375">t&lt;=2</label>
		</location>
		<location id="id10" x="288" y="360">
			<name x="278" y="326">wait_selected</name>
			<label kind="invariant" x="312" y="352">t&lt;=2</label>
		</location>
		<location id="id11" x="-8" y="360">
			<name x="-18" y="326">wait_uninit</name>
			<label kind="invariant" x="-64" y="352">t&lt;=2</label>
		</location>
		<location id="id12" x="-96" y="672">
			<name x="-112" y="640">rec_one0</name>
			<label kind="invariant" x="-104" y="624">t&lt;=2</label>
		</location>
		<location id="id13" x="288" y="672">
			<name x="221" y="671">listening0</name>
			<label kind="invariant" x="216" y="688">t&lt;=2</label>
		</location>
		<location id="id14" x="288" y="448">
			<committed/>
		</location>
		<location id="id15" x="-96" y="1184">
			<name x="-104" y="1136">ready</name>
			<label kind="invariant" x="-104" y="1152">t&lt;=1</label>
		</location>
		<location id="id16" x="488" y="1088">
			<name x="472" y="1040">listening</name>
			<label kind="invariant" x="472" y="1056">t&lt;=2</label>
		</location>
		<location id="id17" x="696" y="1088">
			<name x="712" y="1096">rec_one</name>
			<label kind="invariant" x="712" y="1080">t&lt;=2</label>
		</location>
		<location id="id18" x="72" y="800">
			<name x="56" y="768">done0</name>
			<label kind="invariant" x="56" y="808">t&lt;=2</label>
		</location>
		<location id="id19" x="352" y="1360">
			<name x="336" y="1376">done</name>
			<label kind="invariant" x="344" y="1400">t&lt;=2</label>
		</location>
		<init ref="id3"/>
		<transition>
			<source ref="id2"/>
			<target ref="id0"/>
			<label kind="guard" x="340" y="459">t &gt; 2</label>
			<nail x="340" y="467"/>
			<nail x="272" y="416"/>
			<nail x="221" y="399"/>
			<nail x="-85" y="399"/>
		</transition>
		<transition>
			<source ref="id1"/>
			<target ref="id2"/>
			<label kind="guard" x="102" y="518">counter &lt; 3*frame-1</label>
			<label kind="assignment" x="161" y="535">counter++</label>
			<nail x="238" y="561"/>
			<nail x="238" y="501"/>
		</transition>
		<transition>
			<source ref="id1"/>
			<target ref="id13"/>
			<label kind="guard" x="306" y="569">counter == frame-1 ||
counter == 2*frame-1 ||
counter == 3*frame-1</label>
			<label kind="assignment" x="306" y="620">counter = 0,
mode = 2</label>
		</transition>
		<transition>
			<source ref="id2"/>
			<target ref="id1"/>
			<label kind="guard" x="289" y="510">counter &lt;= 3*frame-1</label>
			<label kind="synchronisation" x="289" y="527">tick?</label>
		</transition>
		<transition>
			<source ref="id9"/>
			<target ref="id0"/>
			<label kind="guard" x="246" y="1343">t &gt; 2</label>
			<nail x="289" y="1377"/>
			<nail x="289" y="1462"/>
			<nail x="-153" y="1462"/>
		</transition>
		<transition>
			<source ref="id3"/>
			<target ref="id15"/>
			<label kind="guard" x="-254" y="1148">id == 0</label>
			<label kind="assignment" x="-254" y="1182">setgatewayVars()</label>
			<nail x="-272" y="1181"/>
		</transition>
		<transition>
			<source ref="id3"/>
			<target ref="id4"/>
			<label kind="guard" x="-93" y="204">id &gt; 0</label>
		</transition>
		<transition>
			<source ref="id4"/>
			<target ref="id10"/>
			<label kind="guard" x="304" y="248">CONFIG_connected[id][aux_id]==1</label>
			<label kind="synchronisation" x="304" y="264">sendWM?</label>
			<label kind="assignment" x="304" y="280">OUTPUT_current=OUTPUT_slot_no[aux_id]</label>
		</transition>
		<transition>
			<source ref="id14"/>
			<target ref="id13"/>
			<label kind="assignment" x="96" y="552">counter=0,
mode=2</label>
			<nail x="88" y="528"/>
			<nail x="88" y="584"/>
		</transition>
		<transition>
			<source ref="id14"/>
			<target ref="id2"/>
			<label kind="assignment" x="314" y="408">counter=0,
mode=1</label>
		</transition>
		<transition>
			<source ref="id7"/>
			<target ref="id6"/>
			<label kind="guard" x="296" y="808">counter&gt;=frame-1</label>
			<label kind="assignment" x="296" y="824">aux_vec=first[id]|second[id],
second[id]=0, 
mode=3</label>
		</transition>
		<transition>
			<source ref="id6"/>
			<target ref="id5"/>
			<label kind="guard" x="168" y="936">!((aux_vec&gt;&gt;1)&amp;1)</label>
			<label kind="assignment" x="168" y="976">OUTPUT_slot_no[id]=1,
aux_vec=0</label>
			<nail x="160" y="912"/>
			<nail x="160" y="1032"/>
			<nail x="288" y="1048"/>
		</transition>
		<transition>
			<source ref="id6"/>
			<target ref="id14"/>
			<label kind="guard" x="-120" y="872">aux_vec==max_vec</label>
			<label kind="assignment" x="-120" y="896">counter=-1,
aux_vec=0,
first[id]=0,
second[id]=0,
collision=-1</label>
			<nail x="-132" y="894"/>
			<nail x="-128" y="448"/>
		</transition>
		<transition>
			<source ref="id6"/>
			<target ref="id5"/>
			<label kind="guard" x="40" y="936">!((aux_vec&gt;&gt;0)&amp;1)</label>
			<label kind="assignment" x="40" y="968">OUTPUT_slot_no[id]=0,
aux_vec=0</label>
			<nail x="32" y="928"/>
			<nail x="32" y="1016"/>
			<nail x="288" y="1048"/>
		</transition>
		<transition>
			<source ref="id5"/>
			<target ref="id16"/>
			<label kind="guard" x="320" y="1056">OUTPUT_current!=OUTPUT_slot_no[id]</label>
		</transition>
		<transition>
			<source ref="id8"/>
			<target ref="id9"/>
			<label kind="synchronisation" x="72" y="1360">sendWM!</label>
			<label kind="assignment" x="64" y="1384">collision=-1</label>
		</transition>
		<transition>
			<source ref="id10"/>
			<target ref="id11"/>
			<label kind="guard" x="80" y="328">CONFIG_connected[id][aux_id]==1</label>
			<label kind="synchronisation" x="80" y="345">sendWM?</label>
		</transition>
		<transition>
			<source ref="id11"/>
			<target ref="id4"/>
			<label kind="synchronisation" x="80" y="281">tick?</label>
		</transition>
		<transition>
			<source ref="id10"/>
			<target ref="id14"/>
			<label kind="synchronisation" x="296" y="384">tick?</label>
			<label kind="assignment" x="296" y="400">OUTPUT_current=(OUTPUT_current+1)%frame</label>
		</transition>
		<transition>
			<source ref="id13"/>
			<target ref="id12"/>
			<label kind="guard" x="-8" y="640">CONFIG_connected[id][aux_id]==1</label>
			<label kind="synchronisation" x="-8" y="656">sendWM?</label>
			<label kind="assignment" x="-8" y="672">rec_vec=first[aux_id],
first[id]|=(1&lt;&lt;OUTPUT_current)</label>
		</transition>
		<transition>
			<source ref="id12"/>
			<target ref="id18"/>
			<label kind="guard" x="-96" y="800">CONFIG_connected[id][aux_id]==1</label>
			<label kind="synchronisation" x="-96" y="816">sendWM?</label>
			<label kind="assignment" x="-96" y="832">collision=(collision&lt;0)?OUTPUT_current:collision,
rec_vec=0</label>
			<nail x="-96" y="736"/>
			<nail x="-96" y="800"/>
		</transition>
		<transition>
			<source ref="id12"/>
			<target ref="id7"/>
			<label kind="synchronisation" x="-16" y="704">tick?</label>
			<label kind="assignment" x="-8" y="720">OUTPUT_current=(OUTPUT_current+1)%frame,
second[id]=second[id]|rec_vec,
rec_vec=0</label>
			<nail x="-96" y="720"/>
			<nail x="256" y="720"/>
		</transition>
		<transition>
			<source ref="id13"/>
			<target ref="id7"/>
			<label kind="synchronisation" x="488" y="688">tick?</label>
			<label kind="assignment" x="492" y="707">OUTPUT_current=(OUTPUT_current+1)%frame</label>
			<nail x="484" y="683"/>
			<nail x="484" y="731"/>
		</transition>
		<transition>
			<source ref="id7"/>
			<target ref="id13"/>
			<label kind="guard" x="296" y="688">counter&lt;frame-1</label>
			<label kind="assignment" x="296" y="704">counter++</label>
		</transition>
		<transition>
			<source ref="id6"/>
			<target ref="id5"/>
			<label kind="guard" x="296" y="936">!((aux_vec&gt;&gt;2)&amp;1)</label>
			<label kind="assignment" x="296" y="976">OUTPUT_slot_no[id]=2,
aux_vec=0</label>
		</transition>
		<transition>
			<source ref="id6"/>
			<target ref="id5"/>
			<label kind="guard" x="424" y="936">!((aux_vec&gt;&gt;3)&amp;1)</label>
			<label kind="assignment" x="424" y="976">OUTPUT_slot_no[id]=3,
aux_vec=0</label>
			<nail x="416" y="912"/>
			<nail x="416" y="1032"/>
			<nail x="288" y="1048"/>
		</transition>
		<transition>
			<source ref="id6"/>
			<target ref="id5"/>
			<label kind="guard" x="552" y="936">!((aux_vec&gt;&gt;4)&amp;1)</label>
			<label kind="assignment" x="552" y="976">OUTPUT_slot_no[id]=4,
aux_vec=0</label>
			<nail x="544" y="928"/>
			<nail x="544" y="1016"/>
			<nail x="288" y="1048"/>
		</transition>
		<transition>
			<source ref="id5"/>
			<target ref="id15"/>
			<label kind="guard" x="-48" y="1176">OUTPUT_current==OUTPUT_slot_no[id]</label>
		</transition>
		<transition>
			<source ref="id15"/>
			<target ref="id8"/>
			<label kind="guard" x="-88" y="1280">t==1</label>
			<label kind="assignment" x="-88" y="1296">aux_id=id,
aux_col=collision</label>
		</transition>
		<transition>
			<source ref="id19"/>
			<target ref="id5"/>
			<label kind="synchronisation" x="328" y="1264">tick?</label>
			<label kind="assignment" x="328" y="1280">OUTPUT_current=(OUTPUT_current+1)%frame</label>
			<nail x="288" y="1216"/>
		</transition>
		<transition>
			<source ref="id16"/>
			<target ref="id17"/>
			<label kind="guard" x="512" y="1064">CONFIG_connected[id][aux_id]==1</label>
			<label kind="synchronisation" x="512" y="1088">sendWM?</label>
			<label kind="assignment" x="512" y="1104">col=aux_col,
first[id]|=(1&lt;&lt;OUTPUT_current)</label>
		</transition>
		<transition>
			<source ref="id17"/>
			<target ref="id19"/>
			<label kind="guard" x="704" y="1272">CONFIG_connected[id][aux_id]==1</label>
			<label kind="synchronisation" x="704" y="1256">sendWM?</label>
			<label kind="assignment" x="704" y="1288">collision=(collision&lt;0)?OUTPUT_current:collision</label>
			<nail x="696" y="1360"/>
		</transition>
		<transition>
			<source ref="id17"/>
			<target ref="id5"/>
			<label kind="guard" x="314" y="1198">col!=OUTPUT_slot_no[id]</label>
			<label kind="synchronisation" x="312" y="1216">tick?</label>
			<label kind="assignment" x="312" y="1232">OUTPUT_current=(OUTPUT_current+1)%frame</label>
			<nail x="640" y="1200"/>
			<nail x="312" y="1200"/>
		</transition>
		<transition>
			<source ref="id16"/>
			<target ref="id5"/>
			<label kind="synchronisation" x="320" y="1136">tick?</label>
			<label kind="assignment" x="320" y="1152">OUTPUT_current=(OUTPUT_current+1)%frame</label>
			<nail x="448" y="1152"/>
			<nail x="312" y="1152"/>
		</transition>
		<transition>
			<source ref="id18"/>
			<target ref="id7"/>
			<label kind="synchronisation" x="96" y="784">tick?</label>
			<label kind="assignment" x="96" y="800">OUTPUT_current=(OUTPUT_current+1)%frame</label>
			<nail x="272" y="800"/>
		</transition>
		<transition>
			<source ref="id17"/>
			<target ref="id13"/>
			<label kind="guard" x="712" y="760">(col==OUTPUT_slot_no[id])</label>
			<label kind="synchronisation" x="712" y="792">tick?</label>
			<label kind="assignment" x="712" y="816">counter=0,
OUTPUT_current=(OUTPUT_current+1)%frame,
col=-1,
collision=-1,
OUTPUT_slot_no[id]=-1,
first[id]=0,
rec_vec=0,
mode=2</label>
			<nail x="696" y="672"/>
		</transition>
		<transition>
			<source ref="id9"/>
			<target ref="id5"/>
			<label kind="synchronisation" x="72" y="1264">tick?</label>
			<label kind="assignment" x="72" y="1280">OUTPUT_current=(OUTPUT_current+1)%frame</label>
			<nail x="288" y="1216"/>
		</transition>
		<transition>
			<source ref="id10"/>
			<target ref="id0"/>
			<label kind="guard" x="357" y="349">t &gt; 2</label>
			<nail x="221" y="399"/>
			<nail x="-85" y="399"/>
		</transition>
		<transition>
			<source ref="id16"/>
			<target ref="id0"/>
			<label kind="guard" x="-179" y="1113">t &gt; 2</label>
			<nail x="229" y="1139"/>
			<nail x="-153" y="1104"/>
		</transition>
		<transition>
			<source ref="id17"/>
			<target ref="id0"/>
			<label kind="guard" x="756" y="1071">t &gt; 2</label>
			<nail x="671" y="1215"/>
			<nail x="671" y="1462"/>
			<nail x="-153" y="1462"/>
			<nail x="-153" y="1079"/>
		</transition>
		<transition>
			<source ref="id12"/>
			<target ref="id0"/>
			<label kind="guard" x="-187" y="663">t &gt; 2</label>
			<nail x="-153" y="654"/>
			<nail x="-153" y="382"/>
		</transition>
		<transition>
			<source ref="id18"/>
			<target ref="id0"/>
			<label kind="guard" x="-187" y="731">t &gt; 2</label>
			<nail x="-153" y="722"/>
		</transition>
		<transition>
			<source ref="id19"/>
			<target ref="id0"/>
			<label kind="guard" x="289" y="1343">t &gt; 2</label>
			<nail x="289" y="1377"/>
			<nail x="289" y="1462"/>
			<nail x="-153" y="1462"/>
		</transition>
		<transition>
			<source ref="id13"/>
			<target ref="id0"/>
			<label kind="guard" x="51" y="603">t &gt; 2</label>
			<nail x="8" y="569"/>
			<nail x="-153" y="569"/>
		</transition>
	</template>
	<template>
		<name x="5" y="5">scheduler</name>
		<location id="id20" x="136" y="120">
			<label kind="invariant" x="126" y="135">t&lt;=2</label>
		</location>
		<init ref="id20"/>
		<transition>
			<source ref="id20"/>
			<target ref="id20"/>
			<label kind="guard" x="76" y="90">t==2</label>
			<label kind="synchronisation" x="76" y="105">tick!</label>
			<label kind="assignment" x="76" y="120">t=0</label>
			<nail x="256" y="144"/>
			<nail x="256" y="48"/>
		</transition>
	</template>
	<system>//Insert process assignments.


//Edit system definition.
system node,scheduler;</system>
	<queries>
		<query>
			<formula>simulate 1 [&lt;=200] { OUTPUT_slot_no[0] &gt; 0, OUTPUT_slot_no[1] &gt; 0, OUTPUT_slot_no[2] &gt; 0, OUTPUT_slot_no[3] &gt; 0, node0.OUTPUT_current, node1.OUTPUT_current, node2.OUTPUT_current, node3.OUTPUT_current }
			</formula>
			<comment>
			</comment>
		</query>
	</queries>
</nta>
